package member;

import java.io.IOException;

import admin.login.AdminDTO;
import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletContext;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.Part;

@MultipartConfig(maxFileSize = 1024 * 1024 * 10)
public class MemberController extends HttpServlet {
	private static final long serialVersionUID = 1L;

	protected void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		String url = request.getRequestURI();
		String path = request.getContextPath();
		MemberDAO dao = new MemberDAO();

		if (url.contains("list_memberInfo.do")) {

		} else if (url.contains("join.do")) {
			String mId = request.getParameter("mId");
			String mPasswd = request.getParameter("mPasswd");
			String mName = request.getParameter("mName");
			String mTel = request.getParameter("mTel");
			String mAddress = request.getParameter("mAddress");
			String mEmail = request.getParameter("mEmail");
			String birthdate = request.getParameter("mBirthDate");

			MemberDTO dto = new MemberDTO();
			dto.setM_id(mId);
			dto.setM_passwd(mPasswd);
			dto.setM_name(mName);
			dto.setM_tel(mTel);
			dto.setM_address(mAddress);
			dto.setM_email(mEmail);
			dto.setM_birth_date(birthdate);

			dao.insert_join(dto);
			String page = "/user/book/main.jsp?message=join";
			RequestDispatcher rd = request.getRequestDispatcher(page);
			rd.forward(request, response);

		} else if (url.contains("detail_memberInfo.do")) {
			String mId = request.getParameter("mId");
			System.out.println("mId : " + mId);
			MemberDTO dto = dao.detailMember(mId);
			request.setAttribute("dto", dto);
			RequestDispatcher rd = request.getRequestDispatcher("/user/member/detail_memberInfo.jsp");
			rd.forward(request, response);
		} else if (url.contains("edit_memberInfo.do")) {
			MemberDTO dto = new MemberDTO();
			ServletContext application = request.getSession().getServletContext();
			String mImg_path = application.getRealPath("/resources/images/member/");
			String mId = request.getParameter("mId");
			String mPasswd = request.getParameter("mPasswd");
			String mName = request.getParameter("mName");
			String mTel = request.getParameter("mTel");
			String mEmail = request.getParameter("mEmail");
			String mZipNo = request.getParameter("mZipNo");
			String mAddress = request.getParameter("mAddress");
			String mDetailAddress = request.getParameter("mDetailAddress");
			String mImg = "";

			// 회원 이미지
			try {
				for (Part part : request.getParts()) {
					mImg = part.getSubmittedFileName();
					if (mImg != null && !mImg.trim().equals("")) {
						part.write(mImg_path + mImg);
						break;
					}
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
			dto.setM_id(mId);
			dto.setM_passwd(mPasswd);
			dto.setM_name(mName);
			dto.setM_tel(mTel);
			dto.setM_email(mEmail);
			dto.setM_zip_no(mZipNo);
			dto.setM_address(mAddress);
			dto.setM_detail_address(mDetailAddress);

			if (mImg == null || mImg.trim().equals("")) {
				MemberDTO dto2 = dao.detailMember(mId);
				mImg = dto2.getM_img();
				dto.setM_img(mImg);
			} else {
				dto.setM_img(mImg);
			}

			System.out.println("mZipNo : " +mZipNo );
			System.out.println("mAddress : " +mAddress );
			System.out.println("mDetailAddress : " +mDetailAddress );
			dao.edit_memberInfo(dto);

			request.setAttribute("dto", dto);
			RequestDispatcher rd = request.getRequestDispatcher("/user/member/detail_memberInfo.jsp");
			rd.forward(request, response);
		}
	}

	protected void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		doGet(request, response);
	}
}
