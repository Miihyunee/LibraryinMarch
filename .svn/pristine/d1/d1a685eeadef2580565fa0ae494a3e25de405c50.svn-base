<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myLibrary">
	<!-- 나의 서재 -->
	<select id="myLibrary_info" resultType="myLibrary.MyLibraryDTO">
		SELECT
		m_no,
		m_id,
		m_name,
		m_tel,
		m_email,
		m_img,
		to_char(m_year, 'yyyy-MM-dd') m_year,
		l_bookid,
		(
		SELECT
		COUNT(*)
		FROM
		sl_member, lo_book
		WHERE m_no = l_memno
		AND m_id =
		#{m_id}
		AND l_return_yn = 'N'
		) lo_book_cnt,
		(
		SELECT
		COUNT(*)
		FROM
		sl_member, re_book
		WHERE m_no = r_memno
		AND m_id = #{m_id}
		) re_book_cnt,
		(
		SELECT
		COUNT(*)
		FROM
		sl_member, lo_book
		WHERE m_no = l_memno
		AND m_id =
		#{m_id}
		) total_cnt
		FROM sl_member, lo_book, re_book
		WHERE m_no = l_memno
		AND m_no
		= r_memno
		AND m_id = #{m_id}
		AND rownum = 1
	</select>

	<select id="myLoanBook" resultType="myLibrary.MyLibraryDTO">
		SELECT
		l_memno,
		l_bookid,
		b_name,
		b_author,
		b_pub,
		b_year,
		b_category,
		b_isbn,
		b_url,
		to_char(l_lodate,
		'yyyy-MM-dd') l_lodate,
		to_char(l_retdate, 'yyyy-MM-dd') l_retdate,
		l_return_yn,
		l_renew_yn,
		( SELECT
		COUNT(*)
		FROM
		sl_member, lo_book
		WHERE
		m_no = l_memno
		AND l_memno = #{l_memno}
		AND l_return_yn = 'N'
		)
		lo_book_cnt
		FROM sl_book, lo_book
		WHERE l_memno = #{l_memno}
		AND b_id =
		l_bookid
		AND l_return_yn = 'N'
	</select>

	<select id="myHistory" resultType="myLibrary.MyLibraryDTO">
		SELECT
		l_bookid,
		b_name,
		b_author,
		b_pub,
		b_year,
		b_category,
		b_isbn,
		b_url,
		to_char(l_lodate,
		'yyyy-MM-dd') l_lodate,
		to_char(l_retdate, 'yyyy-MM-dd') l_retdate,
		to_char(l_complete, 'yyyy-MM-dd') l_complete,
		l_return_yn,
		l_renew_yn,
		(
		SELECT
		COUNT(*)
		FROM
		sl_member, lo_book
		WHERE m_no = l_memno
		AND l_memno =
		#{l_memno}
		) lo_book_cnt
		FROM sl_book, lo_book
		WHERE l_memno = #{l_memno}
		AND b_id = l_bookid
	</select>

	<select id="checkReservation" resultType="int">
		SELECT
			COUNT(*)
		FROM
			re_book
		WHERE r_bookid = #{r_bookid}
	</select>
	
	<update id="updateReturn">
		UPDATE lo_book
		SET l_retdate = l_retdate + 7
		WHERE l_memno = #{l_memno}
		AND l_bookid = #{l_bookid}
	</update>
	
	<!-- 카테고리별 통계 -->
	<select id="cateChart" resultType="map">
		SELECT
			    b_category as category,
			    COUNT(b_category) AS total_cnt
			FROM
			    lo_book a,
			    sl_book b
			WHERE
			        l_memno = #{l_memno}
			    AND l_bookid = b_id
			GROUP BY
			    b_category
	</select>
	
	<!-- 월별 통계 -->
	<select id="monthChart" resultType="map">
		SELECT
		    to_char(l_lodate, 'yyyy.MM') AS category,
		    COUNT(to_char(l_lodate, 'yyyy.MM')) as TOTAL_CNT
	FROM
	    lo_book
	WHERE
	    l_memno = #{l_memno}
	GROUP BY
	    to_char(l_lodate, 'yyyy.MM')
	ORDER BY
	    to_char(l_lodate, 'yyyy.MM')
	</select>
	
	<!-- 연도별 통계 -->
	<select id="yearChart" resultType="map">
		SELECT
	    EXTRACT(YEAR FROM TO_DATE(l_lodate)) as category,
	    COUNT(EXTRACT(YEAR FROM TO_DATE(l_lodate))) as TOTAL_CNT
	FROM
	    lo_book
	WHERE
	    l_memno = #{l_memno}
	GROUP BY
	    EXTRACT(YEAR FROM TO_DATE(l_lodate))
	ORDER BY category
	</select>
</mapper>